# 分层存储系统架构与策略总览

## 一、系统整体架构

```plaintext
┌───────────────────────────────────────────────────────────────────┐
│                          应用层 (main.cpp)                         │
│  ┌─────────────────────────────────────────────────────────────┐  │
│  │                    控制器层 (Controller)                     │  │
│  │  ┌───────────────┐ ┌───────────────┐ ┌───────────────────┐  │  │
│  │  │    读取模块    │ │    写入模块    │ │     删除模块     │  │  │
│  │  │   (read.cpp)   │ │  (write.cpp)  │ │   (delete.cpp)   │  │  │
│  │  └───────┬───────┘ └───────┬───────┘ └────────┬──────────┘  │  │
│  │          │                 │                   │             │  │
│  │  ┌───────┴───────┐ ┌───────┴───────┐ ┌────────┴──────────┐  │  │
│  │  │    过载控制    │ │   垃圾回收    │ │    数据分析模块   │  │  │
│  │  │   (busy.cpp)  │ │   (gc.cpp)    │ │  (data_analysis)  │  │  │
│  │  └───────────────┘ └───────────────┘ └───────────────────┘  │  │
│  └────────────────────────────┬────────────────────────────────┘  │
│                               │                                    │
│  ┌────────────────────────────┴────────────────────────────────┐  │
│  │                       存储层 (Disk/Part)                     │  │
│  │  ┌───────────────┐ ┌───────────────┐ ┌───────────────────┐  │  │
│  │  │    磁盘管理    │ │   分区管理    │ │    单元格管理     │  │  │
│  │  │ (Disk类实现)   │ │  (Part类实现)  │ │   (Cell结构体)   │  │  │
│  │  └───────┬───────┘ └───────┬───────┘ └────────┬──────────┘  │  │
│  │          │                 │                   │             │  │
│  │  ┌───────┴───────┐ ┌───────┴───────┐ ┌────────┴──────────┐  │  │
│  │  │  空闲块管理   │ │  对象管理     │ │     请求管理      │  │  │
│  │  │ (FreeBlock)   │ │  (Object)     │ │      (Req)        │  │  │
│  │  └───────────────┘ └───────────────┘ └───────────────────┘  │  │
│  └─────────────────────────────────────────────────────────────┘  │
└───────────────────────────────────────────────────────────────────┘
```
---

## 二、系统编写思想

### 2.1 模块化设计

- **功能分离**  
  - 读写删除操作分别独立实现（`read.cpp`、`write.cpp`、`delete.cpp`）  
  - 优化功能独立封装（`busy.cpp`、`gc.cpp`）  
  - 数据分析单独抽象（`data_analysis.cpp`）  

- **接口设计**  
  - 公共方法和属性在头文件中声明  
  - 具体实现在对应的 `.cpp` 文件中实现  
  - 私有方法以下划线（`_`）开头标识  

- **代码组织**  
  - 相关功能在同一文件中实现  
  - 使用注释块清晰标识模块功能  
  - 采用格式化注释提高代码可读性  

### 2.2 核心数据结构

| 结构   | 职责描述                                   |
| :----- | :----------------------------------------- |
| **Controller** | 系统核心组件，管理所有资源和操作         |
| **Disk**       | 物理存储设备抽象，包含多个分区和单元格   |
| **Part**       | 磁盘的逻辑划分，管理一组相关数据         |
| **Object**     | 存储数据的基本单位，包含元数据和内容     |
| **Req**        | 访问系统的操作请求，关联对象和操作类型   |
| **Cell**       | 最小存储单元，包含对象数据和请求信息     |
| **FreeBlock**  | 管理连续空闲空间的双向链表节点          |

---

## 三、核心方案

### 3.1 磁盘分区策略  

- **分区构成**  
  - **热点区**：分为热点 1 区和热点 2 区，两组磁头分别服务于各自区域。  
  - **冗余区**：作为热点区与备份区之间的缓冲，处理溢出或异常数据。  
  - **冷数据区（备份区）**：存放只读文件副本，约占总容量 **2/3**。  

- **热点区细分 *tag* 区**  
  - 依据各 *tag* 的最大空间预估将热点区切分为若干 *tag* 子区并可动态调整。  
  - 按归一化读取频率相似度，从高到低排列子区顺序。  

```plaintext
┌─────────────────────────────────────────────────────────────────────┐
│                            磁盘物理布局                              │
├─────────────────────────────┬───────────────────┬───────────────────┤
│         热点区 (1/3)         │     冗余区        │   冷数据区 (2/3)   │
├───────────┬─────────────────┤                   │                   │
│  热点1区   │     热点2区     │                   │                   │
├───┬───┬───┼───┬───┬───┬─────┤                   │                   │
│Tag│Tag│Tag│Tag│Tag│Tag│...  │                   │                   │
│1  │2  │3  │4  │5  │6  │     │                   │                   │
└───┴───┴───┴───┴───┴───┴─────┴───────────────────┴───────────────────┘
```

### 3.2 写入策略  

- **磁盘选择**  
  - **热点 1/2 区**：在多盘间轮流写入，平衡双磁头负载。  
  - **备份区**：跨盘轮流写入副本，保证冗余。  

- ***tag* 子区选择顺序**  
  1. 首选可 **最佳碎片匹配** 的目标 *tag* 区。  
  2. 若无最佳匹配，选择可容纳数据的空闲 *tag* 区。  
  3. 如当前 *tag* 区满，则 **反向** 写入最近邻 *tag* 区。  
  4. 若邻区亦满，则按读取频率相近度向外扩散。  
  5. 全部无空闲时，数据落至冗余区。  

- **反向写入机制**  
  - 相邻 *tag* 区采用对向写入（顺时针 / 逆时针）以提升空间利用率。  
  - 当前区满时即刻启用反向策略。  

```plaintext
┌─────────────────────────────────────────────────────────────────────┐
│                           写入决策流程                               │
│                                                                     │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐           │
│  │ 磁盘选择 │───>│Tag区选择│───>│ 空间匹配 │───>│ 写入执行 │          │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘           │
│        │             │              │             ↑                 │
│        ↓             ↓              ↓             │                 │
│  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐           │
│  │轮流分配  │    │最佳匹配 │     │碎片处理 │───>│冗余区写入│           │
│  └─────────┘    └─────────┘    └─────────┘    └─────────┘           │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.3 读取策略  

- **磁头调度**  
  - 每个磁头按最优 “rpj 序列”（最小 token 消耗）**单向顺序**遍历自己负责的区域，降低寻道与旋转延迟。  

### 3.4 Busy（过载）策略  

- **前置过滤**  
  - 根据最近请求的平均等待时间，丢弃读取频率最低的 *m* 个 *tag* 的新请求。  
  - 若请求目标已在队列或其磁盘块附近存在其他请求，则保留。  

- **后置过滤**  
  - 请求完成后清理队列，淘汰周期 ≥ 104 的陈旧请求。  

```plaintext
┌─────────────────────────────────────────────────────────────────────┐
│                           过载控制系统                               │
├─────────────────────────────┬─────────────────────────────────────┬─┤
│        前置过滤              │             后置过滤                │效│
├───────────────┬─────────────┼─────────────────┬───────────────────┤果│
│  请求特征分析  │  动态阈值调整  │  生存期管理     │  超时请求清理    │监│
├───────────────┴─────────────┼─────────────────┴──────────────────┤测│
│• 孤立请求识别               │• 超时检测 (>104个时间片)             │  │
│• 标签频率排序               │• 状态更新                            │  │
│• 邻居状态检查               │• 资源回收                            │  │
└─────────────────────────────┴─────────────────────────────────────┴─┘
```

### 3.5 GC（垃圾回收）策略  

采用 **多级 GC 机制**：一对多交换（S2M）、多对多交换（M2M）与分区内聚拢。

| 层次 | 关键逻辑 |
| :--- | :------- |
| **S2M** | 在分区间寻找大小匹配的对象组合<br>1. 纯对象交换：大对象 ↔ 多小对象<br>2. 引入空闲块：用空闲块填充大小差异 |
| **M2M** | 动态规划搜索大小总和相等的多对象组合，灵活迁移 |
| **分区内聚拢** | 双向聚拢<br>1. **保持完整**：不分割对象<br>2. **允许分割**：更紧凑排布 |

```plaintext
┌─────────────────────────────────────────────────────────────────────┐
│                        垃圾回收执行顺序                              │
│                                                                     │
│  ┌───────────────┐   ┌───────────────┐   ┌───────────────┐          │
│  │ S2M交换(无空闲)│──>│ S2M交换(含空闲)│──>│    M2M交换    │          │
│  └───────────────┘   └───────────────┘   └───────────────┘          │
│           │                  │                   │                  │
│           └──────────────────┴───────────────────┘                  │
│                              │                                      │
│                     ┌────────┴────────┐                             │
│                     │   分区内聚拢     │                             │
│                     └─────────────────┘                             │
└─────────────────────────────────────────────────────────────────────┘
```

---

> **Tips**  
> - 系统采用模块化设计，各功能独立实现，便于维护和扩展  
> - 数据流和控制流分离，提高系统处理效率  
> - 优化策略动态调整，适应不同负载场景  
